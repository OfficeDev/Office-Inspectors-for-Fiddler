name: $(Year:yy).0.$(date:yy)$(DayOfYear)$(rev:.rr)

trigger: none
pr: none

pool:
  name: Azure Pipelines
  vmImage: 'windows-latest'
  demands:
  - msbuild
  - visualstudio
  - vstest

stages:
- stage: Release
  jobs:
  - job: Sign
    steps:
    - checkout: self
      clean: true
      submodules: recursive

    # Download latest drop from build task
    - task: DownloadBuildArtifacts@1
      inputs:
        buildType: 'specific'
        project: '66af1341-9a01-4509-a5ff-5d71bf70ed37'
        pipeline: '17'
        specificBuildWithTriggering: true
        buildVersionToDownload: 'latest'
        downloadType: 'single'
        artifactName: 'drop'
        downloadPath: '$(System.ArtifactsDirectory)'

    - task: UseDotNet@2
      displayName: 'Install .NetCore 2.x'
      inputs:
        version: '2.x'

    - task: SFP.build-tasks.custom-build-task-1.EsrpCodeSigning@1
      displayName: 'ESRP CodeSigning'
      inputs:
        ConnectedServiceName: 'ESRP CodeSigning Service connection'
        FolderPath: '$(System.ArtifactsDirectory)/drop'
        Pattern: '*.dll'
        signConfigType: inlineSignParams
        inlineOperation: |
          [
                  {
                      "KeyCode" : "CP-230012",
                      "OperationCode" : "SigntoolSign",
                      "Parameters" : {
                          "OpusName" : "Microsoft",
                          "OpusInfo" : "http://www.microsoft.com",
                          "FileDigest" : "/fd \"SHA256\"",
                          "PageHash" : "/NPH",
                          "TimeStamp" : "/tr \"http://rfc3161.gtm.corp.microsoft.com/TSS/HttpTspServer\" /td sha256"
                      },
                      "ToolName" : "sign",
                      "ToolVersion" : "1.0"
                  },
                  {
                      "KeyCode" : "CP-230012",
                      "OperationCode" : "SigntoolVerify",
                      "Parameters" : {},
                      "ToolName" : "sign",
                      "ToolVersion" : "1.0"
                  }
              ]

    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifact: drop'
      pathtoPublish: '$(System.ArtifactsDirectory)/drop'

    # - task: ArchiveFiles@2
    #   inputs:
    #     rootFolderOrFile: '$(System.ArtifactsDirectory)/drop/Win32/MrMAPI/Release_Unicode/MrMAPI.exe'
    #     archiveFile: '$(Build.ArtifactStagingDirectory)/MrMAPI.exe.$(Build.BuildNumber).zip'

    # - task: GitHubRelease@1
    #   inputs:
    #     gitHubConnection: 'stephenegriffin'
    #     repositoryName: '$(Build.Repository.Name)'
    #     action: 'create'
    #     target: '$(Build.SourceVersion)'
    #     tagSource: 'userSpecifiedTag'
    #     tag: '$(Build.BuildNumber)'
    #     title: ${{ parameters.title }} ($(Build.BuildNumber))
    #     releaseNotesSource: 'inline'
    #     releaseNotesInline: |-
    #       Build: *$(Build.BuildNumber)*

    #       ${{ parameters.description }}
    #       If you just want to run MFCMAPI or MrMAPI, get the executables (exe). If you want to debug them, get the symbol files (pdb).

    #       *The 64 bit builds will only work on a machine with 64 bit Outlook installed. All other machines should use the 32 bit builds, regardless of the operating system.*

    #       [![Facebook Badge](http://badge.facebook.com/badge/26764016480.2776.1538253884.png)](http://www.facebook.com/MFCMAPI)
    #       [Download stats](https://hanadigital.github.io/grev/?user=stephenegriffin&repo=mfcmapi)
    #     isDraft: true
    #     isPreRelease: ${{ parameters.prerelease }}
    #     changeLogCompareToRelease: 'lastFullRelease'
    #     changeLogType: 'issueBased'
    #     assets: |
    #       $(Build.ArtifactStagingDirectory)/*.zip
